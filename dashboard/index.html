<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Build18 | Dashboard </title>
    <link href="../output.css" rel="stylesheet">
    <link rel="icon" href="../assets/build18-logo.png" type="image/x-icon">

    <!-- HTML Meta Tags -->
    <title>Build18 | Garage</title>
    <meta name="description" content="Join us for the coolest build event at Carnegie Mellon University!">

    <!-- Facebook Meta Tags -->
    <meta property="og:url" content="https://build18.org">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Build18">
    <meta property="og:description" content="Join us for the coolest build event at Carnegie Mellon University!">
    <meta property="og:image" content="https://i.imgur.com/sbokFjM.png">

    <!-- Twitter Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta property="twitter:domain" content="congenial-engine-pwr979rgp5xf9jg-5500.app.github.dev">
    <meta property="twitter:url" content="https://build18.org">
    <meta name="twitter:title" content="Build18">
    <meta name="twitter:description" content="Join us for the coolest build event at Carnegie Mellon University!">
    <meta name="twitter:image" content="https://i.imgur.com/sbokFjM.png">

    <!-- Microsoft Clarity -->
    <script type="text/javascript">
        (function (c, l, a, r, i, t, y) {
            c[a] = c[a] || function () { (c[a].q = c[a].q || []).push(arguments) };
            t = l.createElement(r); t.async = 1; t.src = "https://www.clarity.ms/tag/" + i;
            y = l.getElementsByTagName(r)[0]; y.parentNode.insertBefore(t, y);
        })(window, document, "clarity", "script", "m5mdsy528d");
    </script>
</head>

<body>

    <!-- Back to home page in top left -->
    <a href="/" class="absolute top-0 left-0 mt-4 ml-4 flex items-center">
        <p class="pl-8 pt-8 text-2xl">
            ← </p>
    </a>

    <section id="dashboard">

        <div class="bg-[#faf7f5]  py-6 sm:py-8 lg:py-12 h-screen">
            <div class="mx-auto max-w-screen-2xl px-4 md:px-8 text-center">
                <p
                    class="text-6xl md:text-9xl font-extrabold bg-clip-text text-transparent bg-[linear-gradient(to_right,theme(colors.purple.400),theme(colors.purple.100),theme(colors.pink.300),theme(colors.orange.400),theme(colors.pink.300),theme(colors.purple.100),theme(colors.purple.400))] bg-[length:200%_auto] animate-gradient">
                    DASHBOARD</p>
                </p>

                <!-- Welcome message -->
                <br>
                <br>
                <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
                <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
                <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-analytics.js"></script>
                <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

                <script>
                    // Initialize Firebase
                    const firebaseConfig = {
                        apiKey: "AIzaSyDmPOF_J6ckarUOmOtkovXH5evbm4wPlDA",
                        authDomain: "cmu-build18.firebaseapp.com",
                        projectId: "cmu-build18",
                        storageBucket: "cmu-build18.appspot.com",
                        messagingSenderId: "803530361718",
                        appId: "1:803530361718:web:f78d57d7ef2ea728194857",
                        measurementId: "G-R0GXBKPJG1"
                    };

                    firebase.initializeApp(firebaseConfig);

                    // Check if user is logged in
                    firebase.auth().onAuthStateChanged(function (user) {
                        if (user) {
                            if (user.email.indexOf("andrew.cmu.edu") == -1) {
                                document.getElementById("change-account").style.display = "block";

                                firebase.auth().signOut().then(function () {
                                    // Sign-out successful.
                                    setTimeout(function () {
                                        window.location.href = "/";
                                    }, 1000);
                                }).catch(function (error) {
                                    // An error happened.
                                    console.log(error);
                                });
                            } else {
                                // User is logged in, show dashboard content
                                document.getElementById("dashboard-content").style.display = "block";

                                // Add to firestore as a new document
                                var db = firebase.firestore();
                                var userId = user.email;

                                db.collection("users").doc(userId).get().then((doc) => {
                                    if (doc.exists) {
                                        console.log(`User ${userId} is already in the database.`);

                                        // Update last login time
                                        db.collection("users").doc(userId).update({
                                            lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                                        }).then(() => {
                                            console.log(`User ${userId} last login updated.`);
                                        }).catch((error) => {
                                            console.error("Error updating last login: ", error);
                                        });

                                        // Show user profile information
                                        document.getElementById("profile-info").style.display = "block";
                                        document.getElementById("profile-photo").src = user.photoURL;
                                        document.getElementById("profile-name").innerText = user.displayName;
                                        document.getElementById("profile-email").innerText = user.email;

                                    } else {
                                        db.collection("users").doc(userId).set({
                                            email: userId,
                                            name: user.displayName,
                                            photoURL: user.photoURL,
                                            team: "",
                                            project: "",
                                            progress: 0,
                                        }).then(() => {
                                            console.log(`User ${userId} added to the database.`);
                                        }).catch((error) => {
                                            console.error("Error adding user to the database: ", error);
                                        });
                                    }
                                }).catch((error) => {
                                    console.error("Error checking user in the database: ", error);
                                });
                            }
                        } else {
                            document.getElementById("logged-out").style.display = "block";

                            setTimeout(function () {
                                window.location.href = "/";
                            }, 1000);
                        }
                    });

                    // wait for the page to load
                    window.onload = function () {
                        // Logout button
                        document.getElementById("logout-button").addEventListener("click", function () {
                            console.log("Logging out...");
                            firebase.auth().signOut().then(function () {
                                // Sign-out successful.
                                setTimeout(function () {
                                    window.location.href = "/";
                                }, 1000);
                            }).catch(function (error) {
                                // An error happened.
                                console.log(error);
                            });
                        });
                    };

                </script>
                <div id="change-account" style="display: none;">
                    <p class="text-2xl pt-32 mt-32">Please login with a CMU account..</p>
                </div>

                <div id="logged-out" style="display: none;">
                    <p class="text-2xl pt-32 mt-32">Something went wrong. Please login again... </p>
                </div>


                <div id="dashboard-content" style="display: none;">
                    <p class="text-2xl pt-32 mt-32">Welcome to the Build18 Dashboard! Here you can view
                        information about your team, your project, and your progress. </p>
                    <br>
                    <br>
                    <p class="text-2xl pt-32 mt-32">Check back soon for updates!</p>
                    <br>
                    <br>

                    <div id="profile-info" style="display: none;">
                        <img id="profile-photo" src="" alt="Profile Photo" class="rounded-full h-32 w-32 mx-auto">
                        <h2 id="profile-name" class="text-2xl pt-4"></h2>
                        <p id="profile-email" class="text-lg"></p>
                    </div>
                    <br>
                    <br>

                    <div id="logout-button" class="relative group max-w-max mx-auto pt-32">
                        <div
                            class="absolute -inset-0.5 bg-gradient-to-r from-orange-600 to-blue-300 rounded-lg blur opacity-75 group-hover:opacity-100 transition duration-1000 group-hover:duration-200 animate-tilt">
                        </div>
                        <a class="pt-32">
                            <button
                                class="relative px-6 py-3 bg-white text-xl font-semibold text-black rounded-lg text-center ">
                                LOGOUT</button>
                        </a>
                    </div><br>

                </div>

            </div>
        </div>
    </section>
    <!-- footer -->
    <footer class="footer py-4 bg-base-200 text-base-content max-h-16">
        <nav class="flex justify-between pl-10">
            <aside>
                <a href="#home">
                    <img class="max-h-8 overflow-hidden" src="../assets/build18-logo.png">
                </a>
            </aside>
            <p class="text-center justify-center mt-1">Build18 © 2024</p>
            <a href="#top" class="text-2xl text-orange-400 text-right pl-8">↑</a>

        </nav>
    </footer>

</body>

</html>