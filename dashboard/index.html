<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Build18 | Dashboard </title>
    <link href="../output.css" rel="stylesheet">
    <link rel="icon" href="../assets/build18-logo.png" type="image/x-icon">

    <!-- HTML Meta Tags -->
    <title>Build18 | Garage</title>
    <meta name="description" content="Join us for the coolest build event at Carnegie Mellon University!">

    <!-- Facebook Meta Tags -->
    <meta property="og:url" content="https://build18.org">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Build18">
    <meta property="og:description" content="Join us for the coolest build event at Carnegie Mellon University!">
    <meta property="og:image" content="https://i.imgur.com/sbokFjM.png">

    <!-- Twitter Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta property="twitter:domain" content="congenial-engine-pwr979rgp5xf9jg-5500.app.github.dev">
    <meta property="twitter:url" content="https://build18.org">
    <meta name="twitter:title" content="Build18">
    <meta name="twitter:description" content="Join us for the coolest build event at Carnegie Mellon University!">
    <meta name="twitter:image" content="https://i.imgur.com/sbokFjM.png">

    <!-- Microsoft Clarity -->
    <script type="text/javascript">
        (function (c, l, a, r, i, t, y) {
            c[a] = c[a] || function () { (c[a].q = c[a].q || []).push(arguments) };
            t = l.createElement(r); t.async = 1; t.src = "https://www.clarity.ms/tag/" + i;
            y = l.getElementsByTagName(r)[0]; y.parentNode.insertBefore(t, y);
        })(window, document, "clarity", "script", "m5mdsy528d");
    </script>
</head>

<body>

    <!-- Back to home page in top left -->
    <a href="/" class="absolute top-0 left-0 mt-4 ml-4 flex items-center">
        <p class="pl-8 pt-8 text-2xl">
            ← </p>
    </a>

    <section id="dashboard">

        <div class="bg-[#faf7f5]  py-6 sm:py-8 lg:py-12 ">
            <div class="mx-auto max-w-screen-2xl px-4 md:px-8 text-center">
                <p
                    class="text-6xl md:text-9xl font-extrabold bg-clip-text text-transparent bg-[linear-gradient(to_right,theme(colors.purple.400),theme(colors.purple.100),theme(colors.pink.300),theme(colors.orange.400),theme(colors.pink.300),theme(colors.purple.100),theme(colors.purple.400))] bg-[length:200%_auto] animate-gradient">
                    DASHBOARD</p>
                </p>
                <br>
                <br>
                <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
                <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
                <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-analytics.js"></script>
                <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

                <script>
                    // Initialize Firebase
                    const firebaseConfig = {
                        apiKey: "AIzaSyDmPOF_J6ckarUOmOtkovXH5evbm4wPlDA",
                        authDomain: "cmu-build18.firebaseapp.com",
                        projectId: "cmu-build18",
                        storageBucket: "cmu-build18.appspot.com",
                        messagingSenderId: "803530361718",
                        appId: "1:803530361718:web:f78d57d7ef2ea728194857",
                        measurementId: "G-R0GXBKPJG1"
                    };

                    firebase.initializeApp(firebaseConfig);

                    // Check if user is logged in
                    firebase.auth().onAuthStateChanged(function (user) {
                        if (user) {
                            if (user.email.indexOf("andrew.cmu.edu") == -1) {
                                document.getElementById("change-account").style.display = "block";

                                firebase.auth().signOut().then(function () {
                                    // Sign-out successful.
                                    setTimeout(function () {
                                        window.location.href = "/";
                                    }, 1000);
                                }).catch(function (error) {
                                    // An error happened.
                                    console.log(error);
                                });
                            } else {
                                // User is logged in, show dashboard content
                                document.getElementById("dashboard-content").style.display = "block";

                                // Add to firestore as a new document
                                var db = firebase.firestore();
                                var userId = user.email;

                                db.collection("users").doc(userId).get().then((doc) => {
                                    if (doc.exists) {
                                        console.log(`User ${userId} is already in the database.`);

                                        // Update last login time
                                        db.collection("users").doc(userId).update({
                                            lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                                        }).then(() => {
                                            console.log(`User ${userId} last login updated.`);
                                        }).catch((error) => {
                                            console.error("Error updating last login: ", error);
                                        });

                                        // Show user profile information
                                        document.getElementById("profile-info").style.display = "block";
                                        document.getElementById("profile-photo").src = user.photoURL;
                                        document.getElementById("profile-name").innerText = user.displayName;
                                        document.getElementById("profile-email").innerText = user.email;

                                        // for admins / exec
                                        db.collection("admin").doc(userId).get().then((doc) => {
                                            if (doc.exists) {
                                                console.log(`User ${userId} is an admin.`);

                                                // Admin user is logged in, show admin content
                                                document.getElementById("admin-content").style.display = "block";
                                            } else {
                                                console.log(`User ${userId} is not an admin.`);
                                            }
                                        }).catch((error) => {
                                            console.error("Error checking admin status: ", error);
                                        });


                                    } else {
                                        db.collection("users").doc(userId).set({
                                            email: userId,
                                            name: user.displayName,
                                            photoURL: user.photoURL,
                                            team: "",
                                            project: "",
                                            progress: 0,
                                        }).then(() => {
                                            console.log(`User ${userId} added to the database.`);
                                        }).catch((error) => {
                                            console.error("Error adding user to the database: ", error);
                                        });
                                    }
                                }).catch((error) => {
                                    console.error("Error checking user in the database: ", error);
                                });
                            }
                        } else {
                            document.getElementById("logged-out").style.display = "block";

                            setTimeout(function () {
                                window.location.href = "/";
                            }, 1000);
                        }
                    });

                    // wait for the page to load
                    window.onload = function () {
                        // Logout button
                        document.getElementById("logout-button").addEventListener("click", function () {
                            console.log("Logging out...");
                            firebase.auth().signOut().then(function () {
                                // Sign-out successful.
                                setTimeout(function () {
                                    window.location.href = "/";
                                }, 1000);
                            }).catch(function (error) {
                                // An error happened.
                                console.log(error);
                            });
                        });

                        // Update button
                        document.getElementById("update-button").addEventListener("click", function () {
                            console.log("Updating user profile...");
                            var shirtSize = document.getElementById("shirtSize").value;
                            var college = document.getElementById("college").value;
                            var classYear = document.getElementById("classYear").value;
                            var gender = document.getElementById("gender").value;
                            var ethnicity = document.getElementById("ethnicity").value;
                            var projectDescription = document.getElementById("projectDescription").value;
                            var teamName = document.getElementById("teamName").value;
                            var teamPassword = document.getElementById("teamPassword").value;

                            var db = firebase.firestore();
                            var userId = firebase.auth().currentUser.email;

                            let updateData = {}
                            if (shirtSize !== null) updateData.shirtSize = shirtSize;
                            if (college !== null) updateData.college = college;
                            if (classYear !== null) updateData.classYear = classYear;
                            if (gender !== null) updateData.gender = gender;
                            if (ethnicity !== null) updateData.ethnicity = ethnicity;
                            if (projectDescription !== null) updateData.project = projectDescription;
                            if (teamName !== null) updateData.team = teamName;

                            db.collection("users").doc(userId).update(updateData).then(() => {
                                console.log(`User ${userId} profile updated.`);
                                alert("Profile updated successfully!");
                            }).catch((error) => {
                                console.error("Error updating user profile: ", error);
                                alert("Error updating profile. Please try again.");
                            });

                            // Check if team exists
                            db.collection("teams").doc(teamName).get().then((doc) => {
                                if (doc.exists) {
                                    console.log(`Team ${teamName} exists.`);
                                    var data = doc.data();
                                    if (data.password == teamPassword) {
                                        console.log(`Team ${teamName} password is correct.`);
                                        db.collection("users").doc(userId).update({
                                            team: teamName,
                                        }).then(() => {
                                            console.log(`User ${userId} team updated.`);
                                            alert("Team updated successfully!");
                                        }).catch((error) => {
                                            console.error("Error updating user team: ", error);
                                            alert("Error updating team. Please try again.");
                                        });
                                    } else {
                                        console.log(`Team ${teamName} password is incorrect.`);
                                        alert("Incorrect team password. Please try again.");
                                    }
                                } else {
                                    alert("New team created!");

                                    // Create new team
                                    db.collection("teams").doc(teamName).set({
                                        password: teamPassword,
                                        members: [userId],
                                        project: projectDescription,
                                    }).then(() => {
                                        console.log(`Team ${teamName} created.`);
                                    }).catch((error) => {
                                        console.error("Error creating team: ", error);
                                        alert("Error creating team. Please try again.");
                                    });
                                }
                            }).catch((error) => {
                                console.error("Error checking team: ", error);
                                alert("Error checking team. Please try again.");
                            });
                        });
                    };

                </script>
                <div id="change-account" style="display: none;">
                    <p class="text-2xl pt-32 mt-32">Please login with a CMU account..</p>
                </div>

                <div id="logged-out" style="display: none;">
                    <p class="text-2xl pt-32 mt-32">Something went wrong. Please login again... </p>
                </div>


                <div id="dashboard-content" style="display: none;">
                    <p class="text-2xl pt-32 mt-32">Welcome to the Build18 Dashboard! Here you can view
                        information about your team, your project, and your progress. </p>
                    <br>
                    <br>
                    <p class="text-2xl pt-32 mt-32">Check back soon for more information! In the meantime, please fill
                        out your profile here - all demographic information is strictly optional and helps us put on a
                        better event for you :)</p>
                    <br>
                    <br>

                    <div id="profile-info" style="display: none;">
                        <img id="profile-photo" src="" alt="Profile Photo" class="rounded-full h-32 w-32 mx-auto">
                        <h2 id="profile-name" class="text-2xl pt-4"></h2>
                        <p id="profile-email" class="text-lg"></p>
                    </div>
                    <br>
                    <br>
                    <h1>Status: <b>Pending</b></h1>
                    <!-- User Profile Info Fields -->
                    <label class="form-control w-full max-w-md mx-auto pt-6">
                        <div class="label">
                            <span class="label-text">Shirt Size</span>
                        </div>
                        <select class="select select-bordered bg-white" id="shirtSize">
                            <option disabled selected>Pick one</option>
                            <option>Small</option>
                            <option>Medium</option>
                            <option>Large</option>
                            <option>XL</option>
                            <option>XXL</option>
                        </select>
                    </label>
                    <label class="form-control w-full max-w-md mx-auto pt-8">
                        <div class="label">
                            <span class="label-text">College</span>
                        </div>
                        <select class="select select-bordered bg-white" id="college">
                            <option disabled selected>Pick one</option>
                            <option>College of Engineering</option>
                            <option>School of Computer Science</option>
                            <option>College of Fine Arts</option>
                            <option>Dietrich College</option>
                            <option>Heinz College</option>
                            <option>Mellon College of Science</option>
                            <option>Tepper School of Business</option>
                        </select>
                    </label>
                    <label class="form-control w-full max-w-md mx-auto pt-8">
                        <div class="label">
                            <span class="label-text">Class Year</span>
                        </div>
                        <select class="select select-bordered bg-white" id="classYear">
                            <option disabled selected>Pick one</option>
                            <option>Undergraduate First Year</option>
                            <option>Undergraduate Sophomore</option>
                            <option>Undergraduate Junior</option>
                            <option>Undergraduate Senior</option>
                            <option>Masters</option>
                            <option>Doctorate</option>
                            <option>Alumni</option>
                            <option>Faculty</option>
                            <option>Staff</option>
                        </select>
                    </label>
                    <label class="form-control w-full max-w-md mx-auto pt-8">
                        <div class="label">
                            <span class="label-text">Gender</span>
                        </div>
                        <select class="select select-bordered bg-white" id="gender">
                            <option disabled selected>Pick one</option>
                            <option>Man</option>
                            <option>Woman</option>
                            <option>Non-binary</option>
                            <option>Prefer Not to Answer</option>
                            <option>Other</option>
                        </select>
                        <input type="text" class="bg-white pt-6" placeholder="Prefer to self-describe">
                    </label>
                    <label class="form-control w-full max-w-md mx-auto pt-8">
                        <div class="label">
                            <span class="label-text">Ethnicity</span>
                        </div>
                        <select class="select select-bordered bg-white" id="ethnicity">
                            <option disabled selected>Pick one</option>
                            <option>Asian Indian</option>
                            <option>Black or African</option>
                            <option>Chinese</option>
                            <option>Filipino</option>
                            <option>Hispanic / Latino / Spanish Origin</option>
                            <option>Japanese</option>
                            <option>Korean</option>
                            <option>Middle Eastern</option>
                            <option>Native American or Alaskan Native</option>
                            <option>Vietnamese</option>
                            <option>Other Asian (Thai, Cambodian, etc)</option>
                            <option>Pacific Islander</option>
                            <option>Other</option>
                            <option>Prefer Not to Answer</option>
                        </select>
                        <input type="text" class="bg-white pt-6" placeholder="Prefer to self-describe">
                    </label>

                    <!-- Project -->
                    <label class="form-control w-full max-w-md mx-auto pt-8">
                        <div class="label">
                            <span class="label-text ">What do you want to build?</span>
                        </div>
                        <textarea class="textarea textarea-bordered h-24 bg-white" id="projectDescription"
                            placeholder="Tell us about your project!"></textarea>
                    </label>

                    <!-- Team -->
                    <label class="form-control w-full max-w-md mx-auto pt-8">
                        <div class="label">
                            <span class="label-text
                            ">Team Name (Create or Join)</span>
                        </div>
                        <input type="text" class="input input-bordered bg-white" placeholder="Team Name" id="teamName">
                    </label>
                    <label class="form-control w-full max-w-md mx-auto">
                        <input type="password" class="input input-bordered bg-white" placeholder="Password"
                            id="teamPassword">
                    </label>

                    <br><br>
                    <div id="update-button" class="relative group max-w-max mx-auto pt-32">
                        <div
                            class="absolute -inset-0.5 bg-gradient-to-r from-orange-600 to-blue-300 rounded-lg blur opacity-75 group-hover:opacity-100 transition duration-1000 group-hover:duration-200 animate-tilt">
                        </div>
                        <a class="pt-32">
                            <button
                                class="relative px-6 py-3 bg-white text-xl font-semibold text-black rounded-lg text-center ">
                                UPDATE</button>
                        </a>
                    </div><br>

                    <div id="admin-content" class="relative group max-w-max mx-auto pt-32" style="display: none;">
                        <div
                            class="absolute -inset-0.5 bg-gradient-to-r from-orange-600 to-blue-300 rounded-lg blur opacity-75 group-hover:opacity-100 transition duration-1000 group-hover:duration-200 animate-tilt">
                        </div>
                        <a class="pt-32" href="/admin">
                            <button
                                class="relative px-6 py-3 bg-white text-xl font-semibold text-black rounded-lg text-center ">
                                ADMIN PORTAL</button>
                        </a>
                    </div><br>

                    <div id="logout-button" class="relative group max-w-max mx-auto pt-32">
                        <a class="pt-32">
                            <button
                                class="relative px-6 py-3 bg-white text-xl font-semibold text-black rounded-lg text-center ">
                                LOGOUT</button>
                        </a>
                    </div><br>
                    <br>

                </div>

            </div>
        </div>
    </section>
    <!-- footer -->
    <footer class="footer py-4 bg-base-200 text-base-content max-h-16">
        <nav class="flex justify-between pl-10">
            <aside>
                <a href="#home">
                    <img class="max-h-8 overflow-hidden" src="../assets/build18-logo.png">
                </a>
            </aside>
            <p class="text-center justify-center mt-1">Build18 © 2024</p>
            <a href="#top" class="text-2xl text-orange-400 text-right pl-8">↑</a>

        </nav>
    </footer>

</body>

</html>